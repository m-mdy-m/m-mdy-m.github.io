---
import BaseLayout from '@layouts/Layout.astro';
import TerminalWindow from '@components/TerminalWindow.astro';
import { getAllPackages } from '@services/packages.service';

const packages = await getAllPackages();

const byCategory: Record<string, typeof packages> = {
  cli: [],
  library: [],
  framework: [],
  tool: []
};

packages.forEach(pkg => {
  byCategory[pkg.category].push(pkg);
});

const categoryConfig = {
  cli: {
    label: 'CLI Tools',
    icon: '‚ö°',
    description: 'Command-line utilities and tools'
  },
  framework: {
    label: 'Frameworks',
    icon: 'üèóÔ∏è',
    description: 'Application frameworks and architectures'
  },
  library: {
    label: 'Libraries',
    icon: 'üìö',
    description: 'Reusable code libraries and packages'
  },
  tool: {
    label: 'Tools',
    icon: 'üîß',
    description: 'Development tools and utilities'
  }
};

const typeIcons = {
  npm: 'üì¶',
  dockerhub: 'üê≥',
  manual: '‚ú®'
};
---

<BaseLayout title="Packages & Tools | Genix">
  <TerminalWindow command="ls packages">
    <div class="space-y-10">
      <!-- Header -->
      <div class="space-y-2 pb-6 border-b border-gray-800">
        <h1 class="text-2xl text-white font-bold">Packages & Tools</h1>
        <p class="text-base text-gray-200 leading-relaxed">
          NPM packages, Docker images, and CLI tools built for developers.
        </p>
      </div>

      <!-- Packages by Category -->
      {Object.entries(byCategory)
        .filter(([_, pkgs]) => pkgs.length > 0)
        .map(([category, pkgs]) => {
          const config = categoryConfig[category as keyof typeof categoryConfig];
          return (
            <div class="space-y-5">
              <div class="flex items-baseline gap-3 pb-3 border-b border-gray-900">
                <span class="text-gray-600">‚ñ∂</span>
                <span class="text-base">{config.icon}</span>
                <h2 class="text-lg text-gray-200 font-semibold">
                  {config.label}
                </h2>
                <span class="text-sm text-gray-600">({pkgs.length})</span>
              </div>
              
              <div class="space-y-6">
                {pkgs.map((pkg, idx) => (
                  <article 
                    class="group space-y-3 animate-fade-in"
                    style={`animation-delay: ${idx * 50}ms`}>
                    
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <div class="flex items-baseline gap-2">
                          <span class="text-base">{typeIcons[pkg.type]}</span>
                          <h3 class="text-lg text-gray-100 group-hover:text-white transition-colors font-medium">
                            {pkg.displayName}
                          </h3>
                          {pkg.version && (
                            <span class="text-xs text-gray-500 font-mono">
                              v{pkg.version}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    <p class="text-base text-gray-200 leading-relaxed">
                      {pkg.description}
                    </p>
                    
                    {/* Stats */}
                    <div class="flex flex-wrap items-center gap-4 text-sm">
                      {pkg.downloads && (
                        <span class="text-gray-400">
                          ‚¨áÔ∏è {pkg.downloads.toLocaleString()}/mo
                        </span>
                      )}
                      
                      {pkg.pulls && (
                        <span class="text-gray-400">
                          üê≥ {pkg.pulls.toLocaleString()} pulls
                        </span>
                      )}
                      
                      {pkg.stars > 0 && (
                        <span class="text-gray-400">
                          ‚≠ê {pkg.stars.toLocaleString()}
                        </span>
                      )}
                      
                      {pkg.license && (
                        <span class="text-gray-500">
                          {pkg.license}
                        </span>
                      )}
                    </div>
                    
                    {/* Keywords */}
                    {pkg.keywords.length > 0 && (
                      <div class="flex flex-wrap gap-2">
                        {pkg.keywords.slice(0, 5).map(keyword => (
                          <span class="text-xs text-gray-400 bg-gray-950 px-2 py-0.5 rounded border border-gray-900">
                            {keyword}
                          </span>
                        ))}
                      </div>
                    )}
                    
                    {/* Links */}
                    <div class="flex flex-wrap gap-4 text-sm pt-1">
                      {pkg.registry && (
                        <a 
                          href={pkg.registry}
                          target="_blank"
                          rel="noopener"
                          class="text-gray-400 hover:text-gray-200 transition-colors">
                          [{pkg.type === 'npm' ? 'npm' : pkg.type === 'dockerhub' ? 'docker' : 'info'}]
                        </a>
                      )}
                      
                      {pkg.repository && (
                        <a 
                          href={pkg.repository}
                          target="_blank"
                          rel="noopener"
                          class="text-gray-400 hover:text-gray-200 transition-colors">
                          [source]
                        </a>
                      )}
                      
                      {pkg.homepage && (
                        <a 
                          href={pkg.homepage}
                          target="_blank"
                          rel="noopener"
                          class="text-gray-400 hover:text-gray-200 transition-colors">
                          [docs]
                        </a>
                      )}
                    </div>
                  </article>
                ))}
              </div>
            </div>
          );
        })
      }

      <!-- Installation Examples -->
      <div class="pt-6 border-t border-gray-900 space-y-4">
        <h3 class="text-base text-gray-300 font-semibold">Quick Install</h3>
        <div class="space-y-3">
          <div class="space-y-1">
            <p class="text-sm text-gray-400">NPM Packages:</p>
            <pre class="text-xs text-gray-500 bg-gray-950 px-3 py-2 rounded border border-gray-900"><code>npm install &lt;package-name&gt;</code></pre>
          </div>
          
          <div class="space-y-1">
            <p class="text-sm text-gray-400">Docker Images:</p>
            <pre class="text-xs text-gray-500 bg-gray-950 px-3 py-2 rounded border border-gray-900"><code>docker pull &lt;image-name&gt;</code></pre>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="pt-6 border-t border-gray-900 space-y-2 text-sm">
        <p class="text-gray-400">
          <span class="text-gray-300">üì° Auto-sync:</span> Package info synced from NPM and Docker Hub
        </p>
        <p class="text-gray-400">
          <span class="text-gray-300">üîÑ Cache:</span> Updates every hour
        </p>
      </div>
    </div>
  </TerminalWindow>
</BaseLayout>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
    opacity: 0;
  }
</style>