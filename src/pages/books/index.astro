---
import BaseLayout from '@layouts/Layout.astro';
import TerminalWindow from '@components/TerminalWindow.astro';
import { getCollection } from 'astro:content';

const books = await getCollection('books');

const statusConfig = {
  'completed': { 
    label: 'Living Edition', 
    color: 'text-green-500',
    bg: 'bg-green-950',
    border: 'border-green-900',
    desc: 'Complete and continuously updated'
  },
  'in-progress': { 
    label: 'In Progress', 
    color: 'text-yellow-500',
    bg: 'bg-yellow-950',
    border: 'border-yellow-900',
    desc: 'Active writing and development'
  },
  'planned': { 
    label: 'Planned', 
    color: 'text-gray-500',
    bg: 'bg-gray-950',
    border: 'border-gray-900',
    desc: 'Outlined and scheduled'
  }
};

// Extract GitHub info
function parseGitHub(url: string) {
  const match = url.match(/github\.com\/([^\/]+)\/([^\/]+)/);
  if (!match) return null;
  return { owner: match[1], repo: match[2].replace('.git', '') };
}
---

<BaseLayout title="Books | Genix">
  <TerminalWindow command="ls books">
    <div class="space-y-10">
      <!-- Header -->
      <div class="space-y-3 pb-6 border-b border-gray-800">
        <h1 class="text-2xl text-white font-bold">Published Works</h1>
        <p class="text-base text-gray-300 leading-relaxed">
          Technical books exploring computer science fundamentals from first principles. All freely available under MIT license.
        </p>
      </div>

      <!-- Books -->
      <div class="space-y-8">
        {books.map((book, idx) => {
          const status = statusConfig[book.data.status];
          const github = book.data.repository ? parseGitHub(book.data.repository) : null;
          
          return (
            <article 
              class="group space-y-4 pb-8 border-b border-gray-900 last:border-0 animate-fade-in"
              style={`animation-delay: ${idx * 100}ms`}
              data-github-owner={github?.owner}
              data-github-repo={github?.repo}>
              
              <!-- Title and Status -->
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1 space-y-2">
                  <h2 class="text-xl text-white font-bold leading-tight">
                    {book.data.title}
                  </h2>
                  {book.data.subtitle && (
                    <p class="text-base text-gray-400 italic">
                      {book.data.subtitle}
                    </p>
                  )}
                </div>
                <div class={`flex items-center gap-2 text-xs ${status.color} ${status.bg} px-3 py-1.5 rounded border ${status.border} whitespace-nowrap`}>
                  <span>‚óè</span>
                  <span>{status.label}</span>
                </div>
              </div>
              
              <!-- Description -->
              <p class="text-base text-gray-300 leading-relaxed">
                {book.data.description}
              </p>
              
              <!-- Tags -->
              {book.data.tags.length > 0 && (
                <div class="flex flex-wrap gap-2">
                  {book.data.tags.map(tag => (
                    <span class="text-xs text-gray-400 bg-gray-950 px-2.5 py-1 rounded border border-gray-900">
                      {tag}
                    </span>
                  ))}
                </div>
              )}
              
              <!-- Links and Stats -->
              <div class="flex flex-wrap items-center gap-4 text-sm pt-2">
                {github && (
                  <div class="flex items-center gap-3 text-gray-500">
                    <span class="github-stars" data-loading="true">‚≠ê ...</span>
                    <span class="github-forks" data-loading="true">üç¥ ...</span>
                  </div>
                )}
                {book.data.repository && (
                  <a 
                    href={book.data.repository}
                    target="_blank"
                    rel="noopener"
                    class="text-gray-400 hover:text-gray-200 transition-colors">
                    [view source]
                  </a>
                )}
                {book.data.pdf && (
                  <a 
                    href={book.data.pdf}
                    target="_blank"
                    rel="noopener"
                    class="text-gray-400 hover:text-gray-200 transition-colors">
                    [download pdf]
                  </a>
                )}
              </div>
            </article>
          );
        })}
      </div>

      <!-- Footer -->
      <div class="pt-6 border-t border-gray-900 space-y-3">
        <div class="space-y-2 text-sm">
          <p class="text-gray-400">
            <span class="text-gray-300">üìö Philosophy:</span> All books are "living editions" ‚Äî continuously updated as understanding deepens
          </p>
          <p class="text-gray-400">
            <span class="text-gray-300">üîì License:</span> MIT ‚Äî free to read, share, and adapt
          </p>
          <p class="text-gray-400">
            <span class="text-gray-300">üí° Contributing:</span> Found an error? Have a suggestion? Open an issue on GitHub
          </p>
        </div>
      </div>
    </div>
  </TerminalWindow>
</BaseLayout>

<script>
  // Fetch GitHub stats for books
  document.addEventListener('DOMContentLoaded', async () => {
    const articles = document.querySelectorAll('article[data-github-owner]');
    
    for (const article of articles) {
      const owner = article.getAttribute('data-github-owner');
      const repo = article.getAttribute('data-github-repo');
      
      if (!owner || !repo) continue;
      
      try {
        const response = await fetch(`https://api.github.com/repos/${owner}/${repo}`);
        if (!response.ok) continue;
        
        const data = await response.json();
        
        const starsEl = article.querySelector('.github-stars');
        const forksEl = article.querySelector('.github-forks');
        
        if (starsEl) {
          starsEl.textContent = `‚≠ê ${data.stargazers_count.toLocaleString()}`;
          starsEl.removeAttribute('data-loading');
        }
        
        if (forksEl) {
          forksEl.textContent = `üç¥ ${data.forks_count.toLocaleString()}`;
          forksEl.removeAttribute('data-loading');
        }
      } catch (error) {
        console.error(`Failed to fetch stats for ${owner}/${repo}:`, error);
      }
    }
  });
</script>

<style>
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .animate-fade-in {
    animation: fade-in 0.5s ease-out forwards;
    opacity: 0;
  }
  
  [data-loading="true"] {
    opacity: 0.5;
  }
</style>