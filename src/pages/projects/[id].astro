---
import ArticleLayout from '@layouts/ArticleLayout.astro';
import { getAllProjects } from '@services/projects.service';
import { Marked } from 'marked';
import { markedHighlight } from 'marked-highlight';
import hljs from 'highlight.js';

export async function getStaticPaths() {
  const projects = await getAllProjects();
  
  return projects.map(project => ({
    params: { id: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;

const marked = new Marked(
  markedHighlight({
    langPrefix: 'hljs language-',
    highlight(code, lang) {
      const language = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language }).value;
    }
  })
);

const readmeHtml = project.readme ? marked.parse(project.readme) : null;

const statusConfig = {
  'active': { 
    label: 'Active', 
    color: 'text-green-500', 
    bg: 'bg-green-950', 
    border: 'border-green-900',
    icon: '‚óè'
  },
  'maintenance': { 
    label: 'Maintenance', 
    color: 'text-yellow-500', 
    bg: 'bg-yellow-950', 
    border: 'border-yellow-900',
    icon: '‚óê'
  },
  'archived': { 
    label: 'Archived', 
    color: 'text-gray-600', 
    bg: 'bg-gray-950', 
    border: 'border-gray-900',
    icon: '‚óã'
  }
};

const status = statusConfig[project.status];
---

<ArticleLayout 
  title={`${project.title} | Genix`}
  description={project.description}
  backLink="/projects"
  backText="back to projects">
  
  <article class="space-y-8">
    <!-- Header -->
    <header class="space-y-5 pb-6 border-b border-gray-800">
      <div class="flex items-start justify-between gap-4">
        <div class="flex-1">
          <h1 class="text-3xl text-white font-bold leading-tight mb-3">
            {project.title}
          </h1>
          <p class="text-gray-300 leading-relaxed">
            {project.description}
          </p>
        </div>
        <div class={`flex items-center gap-1.5 text-sm px-3 py-1.5 rounded border ${status.bg} ${status.color} ${status.border} whitespace-nowrap`}>
          <span>{status.icon}</span>
          <span>{status.label}</span>
        </div>
      </div>

      {/* Language & Stats */}
      <div class="flex flex-wrap items-center gap-4 text-sm">
        {project.language && (
          <div class="flex items-center gap-2">
            <span 
              class="w-3 h-3 rounded-full" 
              style={`background-color: ${project.languageColor}`}
            />
            <span class="text-gray-300">{project.language}</span>
          </div>
        )}
        <span class="text-gray-600">¬∑</span>
        <span class="text-gray-400">‚≠ê {project.stars}</span>
        <span class="text-gray-400">üç¥ {project.forks}</span>
        {project.releases.length > 0 && (
          <>
            <span class="text-gray-600">¬∑</span>
            <a 
              href={project.releases[0].url}
              target="_blank"
              rel="noopener"
              class="text-gray-400 hover:text-white transition-colors">
              {project.releases[0].tag}
            </a>
          </>
        )}
      </div>

      {/* Tags */}
      {project.tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {project.tags.map(tag => (
            <span class="text-sm text-gray-400 bg-gray-950 px-2.5 py-1 rounded border border-gray-900">
              {tag}
            </span>
          ))}
        </div>
      )}

      {/* Links */}
      <div class="flex flex-wrap gap-4 text-sm">
        <a 
          href={project.repository}
          target="_blank"
          rel="noopener"
          class="text-gray-400 hover:text-white transition-colors">
          ‚Üí View on GitHub
        </a>
        {project.homepage && (
          <a 
            href={project.homepage}
            target="_blank"
            rel="noopener"
            class="text-gray-400 hover:text-white transition-colors">
            ‚Üí Homepage
          </a>
        )}
      </div>
    </header>

    <!-- README Content -->
    {readmeHtml ? (
      <div class="article-content prose prose-invert max-w-none">
        <Fragment set:html={readmeHtml} />
      </div>
    ) : (
      <div class="text-center py-16 border border-gray-900 rounded bg-gray-950/50">
        <p class="text-gray-500">No README available for this project.</p>
        <p class="text-sm text-gray-600 mt-2">
          <a href={project.repository} target="_blank" rel="noopener" class="hover:text-gray-400">
            View on GitHub ‚Üí
          </a>
        </p>
      </div>
    )}

    <!-- Footer -->
    <footer class="pt-6 border-t border-gray-900 space-y-3">
      <div class="flex flex-wrap gap-4 text-sm text-gray-500">
        <span>Created: {new Date(project.created).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
        <span>¬∑</span>
        <span>Updated: {new Date(project.updated).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
        <span>¬∑</span>
        <span>Last Push: {new Date(project.pushed).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</span>
      </div>
      
      <a href="/projects" class="inline-block text-gray-400 hover:text-white transition-colors">
        ‚Üê All projects
      </a>
    </footer>
  </article>
</ArticleLayout>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />

<style>
  :global(.hljs) {
    background: rgba(0, 0, 0, 0.6) !important;
    padding: 1.5rem !important;
    border-radius: 0.5rem !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  .article-content :global(a) {
    color: #d0d0d0;
    text-decoration: underline;
    text-decoration-color: rgba(255, 255, 255, 0.3);
    text-underline-offset: 2px;
    transition: all 0.2s;
  }
  
  .article-content :global(a:hover) {
    color: #ffffff;
    text-decoration-color: rgba(255, 255, 255, 0.6);
  }
  
  .article-content :global(img) {
    border-radius: 0.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    margin: 2rem 0;
  }
</style>