---
import ArticleLayout from '@layouts/ArticleLayout.astro';
import { getAllProjects, getProjectById } from '@services/projects.service';
import { Marked } from 'marked';
import { markedHighlight } from 'marked-highlight';
import hljs from 'highlight.js';
export async function getStaticPaths() {
  const projects = await getAllProjects();
  
  return projects.map(project => ({
    params: { id: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;

const marked = new Marked(
  markedHighlight({
    langPrefix: 'hljs language-',
    highlight(code, lang) {
      const language = hljs.getLanguage(lang) ? lang : 'plaintext';
      return hljs.highlight(code, { language }).value;
    }
  })
);

const readmeHtml = project.readme ? marked.parse(project.readme) : null;

const statusConfig = {
  'active': { 
    label: 'Active Development', 
    color: 'text-green-500', 
    bg: 'bg-green-950', 
    border: 'border-green-900' 
  },
  'archived': { 
    label: 'Archived', 
    color: 'text-gray-500', 
    bg: 'bg-gray-950', 
    border: 'border-gray-900' 
  },
  'maintenance': { 
    label: 'Maintenance Mode', 
    color: 'text-yellow-500', 
    bg: 'bg-yellow-950', 
    border: 'border-yellow-900' 
  }
};

const status = statusConfig[project.status];
---

<ArticleLayout 
  title={`${project.title} | Genix`}
  description={project.description}
  backLink="/projects"
  backText="back to projects">
  
  <article class="space-y-10">
    <!-- Header -->
    <header class="space-y-6 pb-8 border-b border-gray-800">
      <div class="space-y-4">
        <div class="flex items-start justify-between gap-4">
          <h1 class="text-3xl md:text-4xl lg:text-5xl text-white font-bold leading-tight tracking-tight flex-1">
            {project.title}
          </h1>
          <div class={`text-sm px-4 py-2 rounded border ${status.bg} ${status.color} ${status.border} whitespace-nowrap`}>
            {status.label}
          </div>
        </div>
        
        <p class="text-lg text-gray-100 leading-relaxed">
          {project.description}
        </p>
      </div>

      {/* Language */}
      {project.language && (
        <div class="flex items-center gap-2">
          <span 
            class="w-3 h-3 rounded-full" 
            style={`background-color: ${project.languageColor}`}
          ></span>
          <span class="text-base text-gray-200">{project.language}</span>
        </div>
      )}

      {/* Tags */}
      {project.tags.length > 0 && (
        <div class="flex flex-wrap gap-2">
          {project.tags.map(tag => (
            <span class="text-sm text-gray-300 bg-gray-950 px-3 py-1 rounded border border-gray-900">
              {tag}
            </span>
          ))}
        </div>
      )}

      {/* Stats & Links */}
      <div class="flex flex-wrap items-center gap-4 text-base">
        <div class="flex items-center gap-4 text-gray-300">
          <span>‚≠ê {project.stars.toLocaleString()}</span>
          <span>üç¥ {project.forks.toLocaleString()}</span>
        </div>
        
        {project.repository && (
          <a href={project.repository}
             target="_blank"
             rel="noopener noreferrer"
             class="text-gray-300 hover:text-white transition-colors">
            ‚Üí View on GitHub
          </a>
        )}
        
        {project.homepage && (
          <a href={project.homepage}
             target="_blank"
             rel="noopener noreferrer"
             class="text-gray-300 hover:text-white transition-colors">
            ‚Üí Homepage
          </a>
        )}
      </div>

      {/* Releases */}
      {project.releases.length > 0 && (
        <div class="space-y-2">
          <h3 class="text-sm text-gray-400 uppercase tracking-wider">Latest Release</h3>
          <a 
            href={project.releases[0].url}
            target="_blank"
            rel="noopener"
            class="inline-flex items-center gap-2 text-gray-200 hover:text-white transition-colors">
            <span class="text-base font-mono">{project.releases[0].tag}</span>
            {project.releases[0].name && (
              <span class="text-sm text-gray-400">- {project.releases[0].name}</span>
            )}
            <span class="text-xs text-gray-500">
              ({new Date(project.releases[0].date).toLocaleDateString()})
            </span>
          </a>
        </div>
      )}
    </header>

    {/* README Content */}
    {readmeHtml ? (
      <div class="article-content prose prose-invert prose-lg max-w-none">
        <Fragment set:html={readmeHtml} />
      </div>
    ) : (
      <div class="text-center py-16 border border-gray-900 rounded-lg">
        <p class="text-gray-400">No README available for this project.</p>
        <p class="text-sm text-gray-500 mt-2">
          <a href={project.repository} target="_blank" rel="noopener" class="text-gray-400 hover:text-gray-300">
            View on GitHub ‚Üí
          </a>
        </p>
      </div>
    )}

    <!-- Footer -->
    <footer class="pt-8 border-t border-gray-900 space-y-4">
      <div class="flex flex-wrap items-center gap-4 text-sm text-gray-400">
        <div>Created: {new Date(project.created).toLocaleDateString()}</div>
        <div>Updated: {new Date(project.updated).toLocaleDateString()}</div>
        <div>Source: {project.source === 'manual' ? 'Manual' : 'GitHub Auto-sync'}</div>
      </div>
      
      <a href="/projects" class="inline-block text-gray-300 hover:text-white transition-colors text-base">
        ‚Üê All projects
      </a>
    </footer>
  </article>
</ArticleLayout>

<!-- Highlight.js theme -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />

<style>
  /* Override hljs background to match our theme */
  :global(.hljs) {
    background: rgba(0, 0, 0, 0.6) !important;
    padding: 1.5rem !important;
    border-radius: 0.5rem !important;
  }
</style>