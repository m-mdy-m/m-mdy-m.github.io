---
import '@styles/global.css';

export interface Props {
  title: string;
  description?: string;
}

const { title, description = 'A terminal-style personal website' } = Astro.props;
---

<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet" />
  </head>
  <body>
    <div class="min-h-screen max-w-3xl mx-auto px-4 py-16 md:py-24 flex items-center">
      <main class="w-full">
        <slot />
      </main>
    </div>
    <script>
      window.terminalHistory = window.terminalHistory || [];
      
      import('../commands.js').then(({ commandRegistry, textOutput, errorOutput }) => {
        const terminalInput = document.getElementById('terminal-input');
        const terminalOutput = document.getElementById('terminal-output');
        let historyIndex = -1;
        
        if (!terminalInput || !terminalOutput) return;
        
        terminalInput.focus();
        
        async function processCommand(commandStr) {
          if (!commandStr.trim()) return;
          
          window.terminalHistory.push(commandStr);
          historyIndex = window.terminalHistory.length;
          
          const parts = commandStr.trim().split(' ');
          const command = parts[0].toLowerCase();
          const args = parts.slice(1);
          
          const promptElement = document.createElement('div');
          promptElement.className = 'flex items-start mb-3 text-sm';
          promptElement.innerHTML = `
            <span class="text-gray-600 mr-2">$</span>
            <span class="text-gray-400">${commandStr}</span>
          `;
          
          terminalOutput.appendChild(promptElement);
          
          let output = '';
          
          if (commandRegistry[command]) {
            try {
              output = await commandRegistry[command].execute(args);
            } catch (error) {
              output = errorOutput(`Error: ${error.message}`);
            }
          } else {
            output = errorOutput(`command not found: ${command}`);
          }
          
          if (output) {
            const outputElement = document.createElement('div');
            outputElement.className = 'mb-4 text-sm animate-fade-in';
            outputElement.innerHTML = output;
            terminalOutput.appendChild(outputElement);
          }
          
          // Scroll to bottom after output is added
          setTimeout(() => {
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
          }, 50);
          
          terminalInput.value = '';
        }
        
        terminalInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            processCommand(terminalInput.value);
          } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            if (historyIndex > 0) {
              historyIndex--;
              terminalInput.value = window.terminalHistory[historyIndex];
            }
          } else if (e.key === 'ArrowDown') {
            e.preventDefault();
            if (historyIndex < window.terminalHistory.length - 1) {
              historyIndex++;
              terminalInput.value = window.terminalHistory[historyIndex];
            } else {
              historyIndex = window.terminalHistory.length;
              terminalInput.value = '';
            }
          } else if (e.key === 'Tab') {
            e.preventDefault();
            const input = terminalInput.value.toLowerCase();
            const availableCommands = Object.keys(commandRegistry);
            const matchingCommands = availableCommands.filter(cmd => cmd.startsWith(input));
            
            if (matchingCommands.length === 1) {
              terminalInput.value = matchingCommands[0];
            } else if (matchingCommands.length > 1 && input) {
              let commonPrefix = input;
              let position = input.length;
              let allMatch = true;
              
              while (allMatch && position < matchingCommands[0].length) {
                const char = matchingCommands[0][position];
                for (let i = 1; i < matchingCommands.length; i++) {
                  if (position >= matchingCommands[i].length || matchingCommands[i][position] !== char) {
                    allMatch = false;
                    break;
                  }
                }
                if (allMatch) {
                  commonPrefix += char;
                  position++;
                }
              }
              
              terminalInput.value = commonPrefix;
              
              const promptElement = document.createElement('div');
              promptElement.className = 'flex items-start mb-3 text-sm';
              promptElement.innerHTML = `
                <span class="text-gray-600 mr-2">$</span>
                <span class="text-gray-400">${input}</span>
              `;
              
              const outputElement = document.createElement('div');
              outputElement.className = 'mb-4 text-sm text-gray-500';
              outputElement.innerHTML = matchingCommands.join('  ');
              
              terminalOutput.appendChild(promptElement);
              terminalOutput.appendChild(outputElement);
              terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }
          }
        });
        
        document.addEventListener('click', () => {
          terminalInput.focus();
        });
      }).catch(error => {
        console.error('Failed to load commands:', error);
      });
    </script>
  </body>
</html>